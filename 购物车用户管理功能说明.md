# 购物车用户管理功能说明

## 功能概述

本系统实现了基于用户名的购物车管理功能，确保每个用户都有独立的购物车和订单。当用户点击购买或加入购物车时，系统会：

1. 检查用户是否已登录
2. 通过用户名获取真实的用户ID
3. 根据用户ID创建属于该用户的订单或购物车

## 核心组件

### 1. 用户管理工具 (userManager.js)

```javascript
import userManager from '../utils/userManager'

// 检查用户是否已登录
if (userManager.isLoggedIn()) {
  // 用户已登录
}

// 获取当前用户名
const username = userManager.getCurrentUsername()

// 获取用户ID（会自动从服务器获取）
const userId = await userManager.getUserId()

// 登录用户
userManager.loginUser('username', userId)

// 登出用户
userManager.logoutUser()
```

### 2. 购物车管理器 (cart.js)

```javascript
import cartManager from '../utils/cart'

// 添加商品到购物车
const result = await cartManager.addToCart(sizeId, quantity, shoeId)

// 获取购物车商品数量
const count = await cartManager.getCartItemCount()

// 获取购物车详情
const details = await cartManager.getCartDetails()
```

### 3. 添加到购物车按钮组件 (AddToCartButton.vue)

```vue
<template>
  <AddToCartButton 
    :shoeId="productId"
    :sizes="availableSizes"
    :maxQuantity="99"
    @cart-updated="onCartUpdated"
  />
</template>
```

## 后端API

### 1. 根据用户名获取用户ID

**接口地址**: `POST /users/getUserIdByUsername`

**请求参数**:
```javascript
{
  username: "用户名"
}
```

**响应示例**:
```javascript
{
  code: 200,
  msg: "获取用户ID成功",
  data: 123
}
```

### 2. 添加商品到购物车

**接口地址**: `POST /cart/addToCart`

**请求参数**:
```javascript
{
  userId: 123,    // 用户ID
  sizeId: 1,      // 尺码ID
  shoeId: 456,    // 商品ID
  quantity: 2     // 数量
}
```

## 使用流程

### 1. 用户登录

```javascript
// 用户登录后，设置用户信息
userManager.loginUser('username', userId)
```

### 2. 添加商品到购物车

```javascript
// 在商品详情页面
async addToCart() {
  // 检查用户是否已登录
  if (!userManager.isLoggedIn()) {
    alert('请先登录后再添加商品到购物车')
    return
  }
  
  // 添加商品到购物车
  const result = await cartManager.addToCart(
    this.selectedSizeId,
    this.quantity,
    this.shoeId
  )
  
  if (result) {
    alert('商品已成功添加到购物车！')
  }
}
```

### 3. 查看购物车

```javascript
// 获取购物车商品数量
const count = await cartManager.getCartItemCount()

// 获取购物车详情
const cartDetails = await cartManager.getCartDetails()
```

## 数据库表结构

### 用户表 (user)
```sql
CREATE TABLE user (
  id INT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) UNIQUE NOT NULL,
  -- 其他字段...
);
```

### 订单表 (orders)
```sql
CREATE TABLE orders (
  order_id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  size_id INT NOT NULL,
  order_number VARCHAR(50) NOT NULL,
  status VARCHAR(20) NOT NULL,
  address_id INT NOT NULL,
  created_at DATE NOT NULL,
  updated_at DATE NOT NULL,
  shipping_fee DECIMAL(10, 2) NOT NULL,
  delivery_time DATE NOT NULL,
  FOREIGN KEY (user_id) REFERENCES user(id)
);
```

### 订单商品数量表 (order_shoe_num)
```sql
CREATE TABLE order_shoe_num (
  order_id INT NOT NULL,
  shoe_id INT NOT NULL,
  shoe_num INT NOT NULL,
  PRIMARY KEY (order_id, shoe_id),
  FOREIGN KEY (order_id) REFERENCES orders(order_id),
  FOREIGN KEY (shoe_id) REFERENCES shoe(shoe_id)
);
```

## 错误处理

### 1. 用户未登录
```javascript
if (!userManager.isLoggedIn()) {
  alert('请先登录后再添加商品到购物车')
  return false
}
```

### 2. 无法获取用户ID
```javascript
const userId = await userManager.getUserId()
if (!userId) {
  alert('无法获取用户信息，请重新登录')
  return false
}
```

### 3. 参数验证
```javascript
if (!sizeId || !quantity || !shoeId) {
  alert('商品信息不完整，请重新选择')
  return false
}
```

## 测试方法

### 1. 测试用户登录
```javascript
// 设置测试用户
userManager.loginUser('testuser', 1)
console.log('用户是否已登录:', userManager.isLoggedIn())
console.log('当前用户名:', userManager.getCurrentUsername())
```

### 2. 测试购物车功能
```javascript
// 添加商品到购物车
const result = await cartManager.addToCart(1, 2, 1)
console.log('添加购物车结果:', result)

// 获取购物车数量
const count = await cartManager.getCartItemCount()
console.log('购物车商品数量:', count)
```

### 3. 使用测试页面
访问 `/test-cart` 页面进行完整的购物车功能测试。

## 注意事项

1. **用户ID缓存**: 系统会缓存用户ID，避免重复请求服务器
2. **登录状态检查**: 每次操作前都会检查用户登录状态
3. **错误提示**: 提供友好的错误提示信息
4. **数据一致性**: 确保每个用户的购物车数据独立
5. **事务处理**: 后端使用事务确保数据一致性

## 扩展功能

1. **购物车同步**: 可以添加购物车数据同步功能
2. **商品库存检查**: 添加商品库存验证
3. **价格计算**: 添加商品价格计算功能
4. **优惠券支持**: 添加优惠券功能
5. **购物车分享**: 添加购物车分享功能
