# 支付逻辑更新说明

## 功能概述

根据需求，已更新确认支付窗口的逻辑，实现了以下功能：

### 1. 取消支付功能
- 当用户点击"取消支付"按钮时，系统会在后端 `orders` 表和 `order_shoe_num` 表中插入对应的数据
- `orders` 表中的 `status` 字段设置为 `0`（待支付状态）
- 用户会收到提示："订单已创建，状态为待支付。您可以稍后重新提交订单进行支付。"

### 2. 确认支付功能
- 当用户点击"确认支付"按钮时，系统会：
  1. 首先检查是否有状态为 `0` 的待支付订单
  2. 如果有待支付订单，会询问用户是否要更新现有订单状态为已支付
  3. 如果用户选择更新现有订单，则将状态从 `0` 更新为 `1`（已支付状态）
  4. 如果用户选择创建新订单，或者没有待支付订单，则创建新的订单记录

### 3. 用户交互优化
- 在提交订单时，如果检测到有待支付的订单，会显示确认对话框
- 用户可以选择更新现有订单或创建新订单
- 支付完成后会清除相关标志，确保下次操作的正确性

## 技术实现

### 新增的函数

1. **`createOrderWithStatus(status)`**
   - 通用的订单创建方法
   - 支持指定订单状态（0=待支付，1=已支付）
   - 包含库存检查、订单创建、商品数量记录等完整流程

2. **`findPendingOrders()`**
   - 查找当前用户的状态为0的待支付订单
   - 返回订单列表供后续处理

3. **`updateOrderStatus(orderNumber, newStatus)`**
   - 更新指定订单号的所有相关订单状态
   - 使用现有的 `/api/order/updateOrder` 接口

### 修改的函数

1. **`cancelPayment()`**
   - 改为异步函数
   - 调用 `createOrderWithStatus('0')` 创建待支付订单
   - 提供用户反馈

2. **`confirmPayment()`**
   - 重构逻辑，优先处理待支付订单的更新
   - 根据用户选择决定是更新现有订单还是创建新订单

3. **`submitOrder()`**
   - 改为异步函数
   - 在显示支付弹窗前检查待支付订单
   - 设置用户选择标志供后续使用

## 数据库影响

### orders 表
- 新增状态为 `0` 的订单记录（取消支付时）
- 状态从 `0` 更新为 `1`（确认支付时）

### order_shoe_num 表
- 对应订单的商品数量记录会正常创建
- 与订单状态保持一致

## 使用流程

1. **用户提交订单** → 系统检查待支付订单 → 显示确认对话框
2. **用户选择更新现有订单** → 点击确认支付 → 状态从0更新为1
3. **用户选择创建新订单** → 点击确认支付 → 创建新订单，状态为1
4. **用户点击取消支付** → 创建订单，状态为0 → 提示用户订单已创建

## 注意事项

1. 所有订单操作都包含完整的错误处理
2. 库存检查在创建订单时进行，但不会阻止待支付订单的创建
3. 用户选择标志会在支付完成后自动清除
4. 支持多商品订单的处理，使用统一的订单号

## 后端接口要求

确保后端提供以下接口：
- `POST /api/order/insertOrder` - 创建订单
- `POST /api/order/updateOrder` - 更新订单
- `POST /api/order/getAll` - 获取所有订单
- `POST /api/orderShoeNum/insertOrderShoeNum` - 创建订单商品数量记录
- `GET /api/inventory/checkInventorySufficient` - 检查库存
- `POST /api/inventory/decreaseInventory` - 减少库存

