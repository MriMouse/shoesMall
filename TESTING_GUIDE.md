# 支付逻辑测试指南

## 测试环境准备

1. 确保后端服务正常运行
2. 确保数据库连接正常
3. 启动前端开发服务器：`npm run serve`

## 测试场景

### 场景1：取消支付测试

**步骤：**
1. 进入订单确认页面
2. 选择商品、尺码和数量
3. 选择收货地址
4. 点击"提交订单"
5. 在支付弹窗中点击"取消支付"

**预期结果：**
- 支付弹窗关闭
- 显示提示："订单已创建，状态为待支付。您可以稍后重新提交订单进行支付。"
- 数据库中 `orders` 表新增状态为 `0` 的订单记录
- 数据库中 `order_shoe_num` 表新增对应的商品数量记录

### 场景2：确认支付（有待支付订单）

**步骤：**
1. 完成场景1的取消支付操作
2. 重新进入订单确认页面
3. 选择相同的商品、尺码和数量
4. 选择收货地址
5. 点击"提交订单"

**预期结果：**
- 显示确认对话框："检测到您有待支付的订单，是否要更新现有订单状态为已支付？"
- 如果选择"确定"：
  - 支付弹窗显示
  - 点击"确认支付"后，原有订单状态从 `0` 更新为 `1`
  - 显示支付成功页面
- 如果选择"取消"：
  - 支付弹窗显示
  - 点击"确认支付"后，创建新的订单记录

### 场景3：确认支付（无待支付订单）

**步骤：**
1. 直接进入订单确认页面
2. 选择商品、尺码和数量
3. 选择收货地址
4. 点击"提交订单"
5. 在支付弹窗中点击"确认支付"

**预期结果：**
- 直接显示支付弹窗
- 点击"确认支付"后，创建新的订单记录，状态为 `1`
- 显示支付成功页面
- 数据库中新增状态为 `1` 的订单记录

### 场景4：支付超时测试

**步骤：**
1. 进入订单确认页面
2. 选择商品、尺码和数量
3. 选择收货地址
4. 点击"提交订单"
5. 等待10秒支付倒计时结束

**预期结果：**
- 支付弹窗自动关闭
- 显示提示："支付超时，请重新提交订单"
- 不会创建任何订单记录

## 数据库验证

### 检查 orders 表
```sql
SELECT * FROM orders WHERE userId = 1 ORDER BY createdAt DESC;
```

### 检查 order_shoe_num 表
```sql
SELECT osn.*, o.orderNumber, o.status 
FROM order_shoe_num osn 
JOIN orders o ON osn.orderId = o.orderId 
WHERE o.userId = 1 
ORDER BY o.createdAt DESC;
```

## 常见问题排查

### 1. 订单创建失败
- 检查后端服务是否正常运行
- 检查数据库连接是否正常
- 查看浏览器控制台是否有错误信息

### 2. 状态更新失败
- 确认后端 `updateOrder` 接口是否正常工作
- 检查订单数据格式是否正确

### 3. 用户选择标志未清除
- 检查支付完成、取消、超时等场景是否正确清除了 `window.shouldUpdateExistingOrder` 标志

## 性能测试

### 并发测试
- 同时打开多个浏览器窗口
- 快速进行取消支付和确认支付操作
- 验证订单状态的一致性

### 数据一致性测试
- 验证 `orders` 表和 `order_shoe_num` 表的数据一致性
- 确认订单号、用户ID、状态等关键字段的正确性

## 浏览器兼容性测试

- Chrome (推荐)
- Firefox
- Safari
- Edge

## 移动端测试

- 在移动设备上测试支付流程
- 验证弹窗和按钮的响应性
- 确认触摸操作的正确性
